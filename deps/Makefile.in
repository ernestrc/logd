
export CC=@CC@
export CFLAGS=@CFLAGS@
export LDFLAGS=@LDFLAGS@
export PREFIX=$(shell pwd)

EXTRA_CFLAGS=@EXTRA_CFLAGS@
STATIC_BUILD=@STATIC_BUILD@
DEVELOP_BUILD=@DEVELOP_BUILD@

LIBDIR = $(PREFIX)/lib
BINDIR = $(PREFIX)/bin
MANDIR = $(PREFIX)/man
SHAREDIR = $(PREFIX)/share
INCDIR = $(PREFIX)/include

OPTS=CC=$(CC) CFLAGS='$(CFLAGS)' LDFLAGS='$(LDFLAGS)' PREFIX=$(PREFIX) 
CFG_FLAGS=$(OPTS) --prefix='$(PREFIX)' --disable-shared
OPENSSL_CFG=--openssldir=$(PREFIX) --prefix=$(PREFIX) no-fuzz-libfuzzer no-fuzz-afl no-unit-test no-shared no-hw no-dso no-threads zlib --with-zlib-include=$(INCDIR) --with-zlib-lib=$(LIBDIR)
    
LIBSLAB = $(LIBDIR)/libslab.a
LIBLUAJIT = $(LIBDIR)/libluajit-5.1.a
LIBUV = $(LIBDIR)/libuv.a
LIBLUV = $(LIBDIR)/libluv.a
LPEG = $(LIBDIR)/liblpeg.a
LPCRE = $(LIBDIR)/liblpcre.a
LIBOPENSSL = $(LIBDIR)/libssl.a
LSSL = $(LIBDIR)/liblssl.a
LZLIB = $(LIBDIR)/liblzlib.a
LIBPCRE = $(LIBDIR)/libpcre.a
LIBZ = $(LIBDIR)/libz.a
LUA_COMPAT= $(INCDIR)/c-api

MUST_STATIC = $(LIBSLAB) $(LIBLUV) $(LPEG) $(LPCRE) $(LSSL) $(LZLIB) $(LUA_COMPAT)
CAN_STATIC = $(LIBLUAJIT) $(LIBUV) $(LIBOPENSSL) $(LIBPCRE) $(LIBZ)

ifeq ($(STATIC_BUILD),yes)
ALL=$(CAN_STATIC) $(MUST_STATIC)
else
ALL=$(MUST_STATIC)
endif

LUAJIT_OPTS=CC=$(CC) CFLAGS='-O2 -fPIC -fomit-frame-pointer' LDFLAGS='$(LDFLAGS)' PREFIX=$(PREFIX) BUILDMODE=static

.DEFAULT: all
.PHONY: clean

all: $(MANDIR) $(SHAREDIR) $(BINDIR) $(INCDIR) $(LIBDIR) $(ALL)

$(PREFIX)/%:
	@ mkdir -p $@

$(LIBUV):
	@ echo "  COMPILING	libuv"
	@ cd libuv && ./autogen.sh && ./configure $(CFG_FLAGS) && $(MAKE) && $(MAKE) install

$(LIBLUAJIT):
	@ echo "  COMPILING	luajit"
	@ cd luajit && $(MAKE) $(LUAJIT_OPTS) && $(MAKE) install $(LUAJIT_OPTS)

$(LIBOPENSSL): $(LIBZ)
	@ echo "  COMPILING libopenssl"
	@ cd openssl && \
		./config $(OPENSSL_CFG) && $(MAKE) $(OPTS) && $(MAKE) install $(OPTS)

$(LIBPCRE):
	@ echo "  COMPILING	libpcre"
	@ cp pcre.patch pcre/pcre.patch
	@- cd pcre && patch -N -p1 < pcre.patch
	@ cd pcre && aclocal && automake && autoconf && ./configure $(CFG_FLAGS) && $(MAKE) $(OPTS) && $(MAKE) install $(OPTS)

$(LIBZ):
	@ echo "  COMPILING	zlib"
	@ cd zlib && ./configure --static --prefix=$(PREFIX) && $(MAKE) TEST_LDFLAGS='-L. libz.a $(LDFLAGS)' $(OPTS) && $(MAKE) install $(OPTS)

$(LIBSLAB):
	@ echo "  COMPILING	libslab"
	@ cd slab && $(MAKE)
	@ cp slab/lib/libslab.a $(LIBSLAB)
	@ mkdir -p $(INCDIR)/slab && cp slab/src/*.h $(INCDIR)/slab

ifeq ($(STATIC_BUILD),yes)
LIBLUVDEPS=$(LUA_COMPAT) $(LIBLUAJIT)
else
LIBLUVDEPS=$(LUA_COMPAT)
endif
$(LIBLUV): $(LIBLUVDEPS)
	@ echo "  COMPILING	luv"
	@ cp luv.patch luv/luv.patch
	@- cd luv && patch -N -p1 < luv.patch
	$(CC) $(CFLAGS) -c luv/src/luv.c -o luv/src/luv.o && $(AR) rcs $(LIBLUV) luv/src/luv.o
	@ mkdir -p $(INCDIR)/luv && cp luv/src/*.h  $(INCDIR)/luv

ifeq ($(STATIC_BUILD),yes)
LPEGDEPS=$(LIBLUAJIT)
endif
$(LPEG): $(LPEGDEPS)
	@ echo "  COMPILING	lpeg"
	@ cp lpeg.patch lpeg/lpeg.patch
	@- cd lpeg && patch -N -p1 < lpeg.patch
	@ cd lpeg && $(MAKE)
	@ cd lpeg && $(AR) rcs $(LPEG) *.o && ranlib $(LPEG)

ifeq ($(STATIC_BUILD),yes)
LPCREDEPS=$(LIBLUAJIT)
endif
$(LPCRE): $(LPCREDEPS)
	@ echo "  COMPILING	lpcre"
	@ cp Makefile.lrexlib lrexlib/Makefile
	@ cd lrexlib && $(MAKE) CFLAGS="$(CFLAGS) -DLUA_VERSION_NUM=501 -DLUA_LIB -DLUA_COMPAT_APIINTCASTS -DVERSION='\"2.8.0\"'"
	@ cp lrexlib/lpcre.a $(LPCRE)

ifeq ($(STATIC_BUILD),yes)
LSSLDEPS=$(LIBOPENSSL)
endif
$(LSSL): $(LSSLDEPS)
	@ echo "  COMPILING	lua-openssl"
	@ cd lua-openssl && $(MAKE) libopenssl.a TARGET_FLAGS='-DPTHREADS -DOPENSSL_NO_SM2 -DOPENSSL_NO_STDIO $(CFLAGS)'
	@ cp lua-openssl/libopenssl.a $(LSSL)

ifeq ($(STATIC_BUILD),yes)
LIBZDEPS=$(LIBLUAJIT)
endif
$(LZLIB): $(LIBZDEPS)
	@ echo "  COMPILING	lua-zlib"
	cd lua-zlib && $(CC) $(CFLAGS) -c -o lua_zlib.o lua_zlib.c
	@ cd lua-zlib/ && $(AR) rcs $(LZLIB) *.o && ranlib $(LZLIB)

$(LUA_COMPAT):
	@ echo "  LN lua-compat"
	@ ln -s $(PREFIX)/luv/deps/lua-compat-5.3/c-api $(LUA_COMPAT)

clean:
	@- rm -rf $(LIBDIR) $(BINDIR) $(INCDIR) $(MANDIR) $(SHAREDIR)
